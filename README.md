# 技术需求
### 需求说明：
1. **Stateful Token to Stateless Token Migration:**
   - 设计一个机制，将现有的有状态令牌迁移到无状态访问令牌。
   - 确保系统在迁移过程中无缝处理，不影响用户体验。
   - 在迁移过程中保持数据一致性和完整性。

2. **Data Transfer from NoSQL to Relational Database:**
   - 分析现有的NoSQL数据库中的数据结构，并设计适当的关系数据库模式（例如PostgreSQL）来存储转移的数据。
   - 开发一个高效的数据转移机制，将数据从NoSQL迁移到关系数据库。
   - 确保转移过程中数据的一致性和完整性。

3. **Sharding:**
   - 实施分片，将负载分布到多个数据库实例。
   - 定义一个分片策略，允许高吞吐量和低延迟。
   - 确保数据分布和跨分片的负载平衡。

4. **High TPS and Low Latency:**
   - 设计系统以高效地处理每秒高交易量（TPS）。
   - 优化系统以实现低延迟，为用户提供快速响应时间。
   - 实施适当的缓存机制以提高性能。

### 交付物：
1. 系统架构图，展示涉及的组件及其交互。
2. 关系数据库的数据库模式设计。
3. 有状态令牌到无状态访问令牌的迁移机制。
4. 从NoSQL到关系数据库的数据转移机制。
5. 分片策略和实施细节。
6. 性能测试结果，展示高TPS和低延迟。

### 评估标准：
1. 设计：候选人应该展示一个经过深思熟虑的设计，满足所有要求。
2. 可扩展性：解决方案应通过分片和有效处理高TPS来实现可扩展性。
3. 数据完整性：迁移和转移机制应保持一致性和完整性。
4. 性能：系统应表现出低延迟和高吞吐量。
5. 文档：候选人应提供清晰、简洁的文档，解释解决方案。

# 技术方案
迁移方案概述
分析现有令牌：了解现有有状态令牌的结构、存储方式、过期策略和使用场景。

设计无状态令牌结构：定义无状态访问令牌的结构，包括所需的声明（claims）和有效期。

逐步迁移：通过阶段性迁移实现无缝过渡，包括并行处理现有和新令牌。

数据一致性：确保在迁移过程中，用户的身份信息和权限得到一致性维护。

监控和回滚机制：在迁移过程中监控系统状态，并建立回滚机制以防万一。

迁移步骤
1. 分析现有令牌
   识别当前有状态令牌的生成、存储和验证流程。
   收集用户身份信息、权限及其他必要数据，以便在无状态令牌中使用。
2. 设计无状态令牌结构
   定义 JWT 的声明，包括：
   sub（主题）：用户唯一标识。
   exp（过期时间）：令牌的有效期。
   iat（签发时间）：令牌的生成时间。
   自定义声明（如角色、权限等）。
   示例 JWT 结构：
```json
{
"sub": "user123",
"exp": 1700000000,
"iat": 1600000000,
"roles": ["ROLE_USER"]
}
```

3. 逐步迁移
   阶段一：在应用程序中实现 JWT 生成和验证功能，同时保留现有的有状态令牌机制。

用户登录时，生成无状态访问令牌（JWT）并返回给用户，同时保留有状态令牌的生成与验证流程。
在此阶段，用户可以使用新的 JWT 令牌和现有的有状态令牌。
阶段二：逐步引导用户使用无状态令牌。

在登录时检查用户的有状态令牌，如果存在，则在后台生成并返回新的 JWT 令牌。
用户在使用无状态令牌时，逐渐减少对有状态令牌的依赖。
阶段三：完全切换到无状态令牌。

缓存预热：确保用户的权限和身份信息在缓存中预热，以提高系统性能。
在所有用户成功使用 JWT 后，停用有状态令牌的相关逻辑和存储。
可灰度、可回滚、可降级
4. 数据一致性
   确保在用户使用新令牌（JWT）时，系统能一致地访问用户的权限和身份信息。
   在生成 JWT 时，从已有的用户数据库中提取必要信息，并验证用户的权限和角色。
5. 监控和回滚机制
   监控迁移过程中的系统性能、用户反馈和异常情况。
   如果发现重大问题，确保能够快速回滚到有状态令牌的系统，避免对用户体验的影响。
   迁移完成后
   更新文档，说明新的无状态令牌机制的使用和相关 API 的变更。
   进行用户培训和通知，确保用户了解新机制的优势和使用方法。

# 技术架构


# 领域模型


# 核心流程

## session令牌
<img width="682" alt="image" src="https://github.com/user-attachments/assets/464ab647-846a-4455-916e-7a21277a631b">

## jwt令牌
<img width="705" alt="image" src="https://github.com/user-attachments/assets/a928988d-a786-4cfb-93e7-5814d06e5f1b">

## 数据迁移

## 


# 接口说明

# 

